{
    "patch": "diff --git a/pygments/formatters/terminal256.py b/pygments/formatters/terminal256.py\nindex 6402d8c4..0ad8449f 100644\n--- a/pygments/formatters/terminal256.py\n+++ b/pygments/formatters/terminal256.py\n@@ -223,25 +223,31 @@ class Terminal256Formatter(Formatter):\n \n     def _setup_styles(self):\n         for ttype, ndef in self.style:\n+            # Create a fresh escape sequence for every token type.\n+            # This avoids leaking attributes (fg/bg/bold/underline/italic)\n+            # between tokens.\n             escape = EscapeSequence()\n+\n             # get foreground from ansicolor if set\n             if ndef['ansicolor']:\n                 escape.fg = self._color_index(ndef['ansicolor'])\n             elif ndef['color']:\n                 escape.fg = self._color_index(ndef['color'])\n+\n             if ndef['bgansicolor']:\n                 escape.bg = self._color_index(ndef['bgansicolor'])\n             elif ndef['bgcolor']:\n                 escape.bg = self._color_index(ndef['bgcolor'])\n+\n             if self.usebold and ndef['bold']:\n                 escape.bold = True\n             if self.useunderline and ndef['underline']:\n                 escape.underline = True\n             if self.useitalic and ndef['italic']:\n                 escape.italic = True\n+\n             self.style_string[str(ttype)] = (escape.color_string(),\n                                              escape.reset_string())\n-\n     def _write_lineno(self, outfile):\n         self._lineno += 1\n         outfile.write(\"%s%04d: \" % (self._lineno != 1 and '\\n' or '', self._lineno))\n@@ -323,16 +329,20 @@ class TerminalTrueColorFormatter(Terminal256Formatter):\n \n     def _setup_styles(self):\n         for ttype, ndef in self.style:\n+            # Create a fresh escape sequence for every token type.\n             escape = EscapeSequence()\n+\n             if ndef['color']:\n                 escape.fg = self._color_tuple(ndef['color'])\n             if ndef['bgcolor']:\n                 escape.bg = self._color_tuple(ndef['bgcolor'])\n+\n             if self.usebold and ndef['bold']:\n                 escape.bold = True\n             if self.useunderline and ndef['underline']:\n                 escape.underline = True\n             if self.useitalic and ndef['italic']:\n                 escape.italic = True\n+\n             self.style_string[str(ttype)] = (escape.true_color_string(),\n                                              escape.reset_string())\ndiff --git a/tests/test_terminal_formatter.py b/tests/test_terminal_formatter.py\nindex 20ae9a90..f73f9956 100644\n--- a/tests/test_terminal_formatter.py\n+++ b/tests/test_terminal_formatter.py\n@@ -10,7 +10,7 @@ import re\n from io import StringIO\n \n from pygments.lexers.sql import PlPgsqlLexer\n-from pygments.formatters import TerminalFormatter, Terminal256Formatter, \\\n+from pygments.formatters import TerminalFormatter, Terminal256Formatter, TerminalTrueColorFormatter, \\\n     HtmlFormatter, LatexFormatter\n \n from pygments.style import Style\n@@ -98,3 +98,11 @@ def test_256esc_seq():\n     assert '92;42' in termtest('123')\n     assert '90' in termtest('#comment')\n     assert '94;41' in termtest('\"String\"')\n+\n+\n+def test_terminal256_and_truecolor_no_nameerror_and_nonempty():\n+    code = 'def f():\\n    return 1\\n'\n+    for formatter in (Terminal256Formatter(), TerminalTrueColorFormatter()):\n+        out = highlight(code, Python3Lexer(), formatter)\n+        assert out, \"formatter produced empty output\"\n+        assert '\\x1b[' in out, \"expected ANSI escape sequence in output\"\n",
    "success": false,
    "steps": 23,
    "estimated_tokens": 18898
}