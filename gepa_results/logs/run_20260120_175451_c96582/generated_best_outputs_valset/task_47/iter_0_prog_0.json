{
    "patch": "diff --git a/pygments/formatters/__init__.py b/pygments/formatters/__init__.py\nindex 014de975..3279b630 100644\n--- a/pygments/formatters/__init__.py\n+++ b/pygments/formatters/__init__.py\n@@ -29,8 +29,8 @@ def _fn_matches(fn, glob):\n     \"\"\"Return whether the supplied file name fn matches pattern filename.\"\"\"\n     if glob not in _pattern_cache:\n         pattern = _pattern_cache[glob] = re.compile(fnmatch.translate(glob))\n-        return pattern.match(fn)\n-    return _pattern_cache[glob].match(fn)\n+        return pattern.search(fn)\n+    return _pattern_cache[glob].search(fn)\n \n \n def _load_formatters(module_name):\n@@ -97,22 +97,33 @@ def load_formatter_from_file(filename, formattername=\"CustomFormatter\", **option\n     .. versionadded:: 2.2\n     \"\"\"\n     try:\n-        # This empty dict will contain the namespace for the exec'd file\n         custom_namespace = {}\n-        with open(filename, 'rb') as f:\n+        with open(filename, 'r', encoding='utf-8') as f:\n             exec(f.read(), custom_namespace)\n-        # Retrieve the class `formattername` from that namespace\n+\n         if formattername not in custom_namespace:\n-            raise ClassNotFound(f'no valid {formattername} class found in {filename}')\n-        formatter_class = custom_namespace[formattername]\n-        # And finally instantiate it with the options\n+            raise ClassNotFound(\n+                f\"cannot find formatter class {formattername!r} in {filename!r}\"\n+            )\n+\n+        formatter_class = custom_namespace.get(formattername)\n+        # Avoid importing at module import time.\n+        from pygments.formatter import Formatter\n+        if (not isinstance(formatter_class, type) or\n+                not issubclass(formatter_class, Formatter)):\n+            raise ClassNotFound(\n+                f\"{formattername!r} in {filename!r} is not a Formatter subclass\"\n+            )\n+\n         return formatter_class(**options)\n-    except OSError as err:\n+    except FileNotFoundError as err:\n         raise ClassNotFound(f'cannot read {filename}: {err}')\n     except ClassNotFound:\n         raise\n     except Exception as err:\n-        raise ClassNotFound(f'error when loading custom formatter: {err}')\n+        raise ClassNotFound(\n+            f'error loading formatter {formattername!r} from {filename!r}: {err}'\n+        )\n \n \n def get_formatter_for_filename(fn, **options):\ndiff --git a/tests/test_cmdline.py b/tests/test_cmdline.py\nindex 4d159604..08a18160 100644\n--- a/tests/test_cmdline.py\n+++ b/tests/test_cmdline.py\n@@ -292,7 +292,7 @@ def test_errors():\n     # formatter file is malformed\n     e = check_failure('-f', path.join(TESTDIR, 'support', 'empty.py'),\n                       '-x', TESTFILE)\n-    assert 'Error: no valid CustomFormatter class found' in e\n+    assert \"Error: cannot find formatter class 'CustomFormatter'\" in e\n \n     # output file not writable\n     e = check_failure('-o', os.path.join('nonexistent', 'dir', 'out.html'),\n@@ -322,3 +322,29 @@ def test_exception():\n def test_parse_opts():\n     assert cmdline._parse_options(['  ', 'keyonly,key = value ']) == \\\n         {'keyonly': True, 'key': 'value'}\n+\n+def test_load_custom_formatter_from_file(tmp_path):\n+    # Regression test: loading a custom formatter class from a file via\n+    # \"-x -f path/to/file.py:ClassName\" must work.\n+    fmtfile = tmp_path / \"custom_formatter.py\"\n+    fmtfile.write_text(\n+        \"from pygments.formatter import Formatter\\n\"\n+        \"\\n\"\n+        \"class CustomFormatter(Formatter):\\n\"\n+        \"    def format(self, tokensource, outfile):\\n\"\n+        \"        for ttype, value in tokensource:\\n\"\n+        \"            outfile.write(value.encode('utf-8'))\\n\",\n+        encoding=\"utf-8\",\n+    )\n+\n+    out = check_success(\n+        \"-x\",\n+        \"-f\",\n+        f\"{fmtfile}:CustomFormatter\",\n+        \"-l\",\n+        \"python\",\n+        TESTFILE,\n+    )\n+    # The formatter writes raw token values, so the output should contain\n+    # the source code snippet.\n+    assert \"print\" in out\n",
    "success": false,
    "steps": 25,
    "estimated_tokens": 15871
}