{
    "patch": "diff --git a/pygments/formatters/latex.py b/pygments/formatters/latex.py\nindex 2f7971e8..3eaf91db 100644\n--- a/pygments/formatters/latex.py\n+++ b/pygments/formatters/latex.py\n@@ -482,22 +482,36 @@ class LatexEmbeddedLexer(Lexer):\n             else:\n                 yield i, None, v\n \n-    def _filter_to(self, it, pred):\n-        \"\"\" Keep only the tokens that match `pred`, merge the others together \"\"\"\n-        buf = ''\n-        idx = 0\n-        for i, t, v in it:\n-            if pred(t):\n-                if buf:\n-                    yield idx, None, buf\n-                    buf = ''\n+    def _filter_to(self, tokensource, protect_predicate):\n+        \"\"\"\n+        Group an *unprocessed* token stream into chunks that are either\n+        \"protected\" (returned with their token type) or \"unprotected\"\n+        (returned with token type ``None`` and merged into larger text runs).\n+\n+        This is used by :meth:`_find_safe_escape_tokens` to ensure that escape\n+        delimiters are only searched for in non-string/comment text.\n+\n+        Yields tuples ``(index, ttype_or_None, value)``.\n+        \"\"\"\n+        buf = []\n+        buf_index = None\n+\n+        def flush():\n+            nonlocal buf, buf_index\n+            if buf:\n+                yield buf_index, None, ''.join(buf)\n+                buf = []\n+                buf_index = None\n+\n+        for i, t, v in tokensource:\n+            if protect_predicate(t):\n+                yield from flush()\n                 yield i, t, v\n             else:\n                 if not buf:\n-                    idx = i\n-                buf += v\n-        if buf:\n-            yield idx, None, buf\n+                    buf_index = i\n+                buf.append(v)\n+        yield from flush()\n \n     def _find_escape_tokens(self, text):\n         \"\"\" Find escape tokens within text, give token=None otherwise \"\"\"\ndiff --git a/pygments/formatters/terminal.py b/pygments/formatters/terminal.py\nindex 5c388051..371a7869 100644\n--- a/pygments/formatters/terminal.py\n+++ b/pygments/formatters/terminal.py\n@@ -92,8 +92,8 @@ class TerminalFormatter(Formatter):\n         return Formatter.format(self, tokensource, outfile)\n \n     def _write_lineno(self, outfile):\n+        outfile.write(\"%s%04d: \" % (self._lineno != 0 and '\\n' or '', self._lineno))\n         self._lineno += 1\n-        outfile.write(\"%s%04d: \" % (self._lineno != 1 and '\\n' or '', self._lineno))\n \n     def _get_color(self, ttype):\n         # self.colorscheme is a dict containing usually generic types, so we\n",
    "success": false,
    "steps": 20,
    "estimated_tokens": 13514
}